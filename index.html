<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coach Game Score Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- EmailJS – MUST load before Firebase script -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    (function(){
        emailjs.init("js0OsdaHtUNCJw2vP"); /* YOUR PUBLIC KEY */
    })();
  </script>

  <!-- Basic styling -->
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
      color: #222;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.45rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-top: 0.25rem;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #e53935;
      color: #fff;
    }
    button.secondary {
      background: #757575;
    }
    button.blue {
      background: #1565c0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.4rem;
    }
    th {
      background: #f0f0f0;
    }
    .inline-input {
      width: 70px;
    }
    .message {
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    .success { color: #2e7d32; }
    .error { color: #c62828; }

    .auth-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .auth-row .buttons {
      display: flex;
      gap: 0.5rem;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .toolbar label {
      margin-top: 0;
      font-weight: 500;
    }
    .toolbar select {
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Coach Game Score Sender</h1>

    <!-- AUTH -->
    <div class="card">
      <div class="auth-row">
        <div>
          <strong>Account</strong>
          <div id="authStatus" class="small">Not signed in</div>
        </div>
        <div class="buttons">
          <button id="loginBtn" type="button">Sign in with Google</button>
          <button id="logoutBtn" type="button" style="display:none; background:#555;">
            Log out
          </button>
        </div>
      </div>
      <div id="authMessage" class="message"></div>
    </div>

    <!-- SETTINGS -->
    <div class="card">
      <h2>1. Season Setup</h2>
      <form id="settingsForm">
        <label>Program / Team Name (e.g., Terrell Tigers)</label>
        <input id="teamName" type="text" required />

        <label>Season (e.g., 2025, 2025-2026)</label>
        <input id="season" type="text" required />

        <label>Email List (comma separated)</label>
        <textarea id="emails" required></textarea>

        <button type="submit">Save Settings</button>
        <div id="settingsMessage" class="message"></div>
      </form>
    </div>

    <!-- ADD GAME -->
    <div class="card">
      <h2>2. Add Games to Schedule</h2>

      <form id="gameForm">
        <label>Date</label>
        <input id="gameDate" type="date" required />

        <label>Team Level (Varsity, JV, Freshman, etc.)</label>
        <input id="teamLevel" type="text" placeholder="Varsity, JV, Freshman" required />

        <label>Opponent</label>
        <input id="opponent" type="text" required />

        <label>Location</label>
        <input id="location" type="text" required />

        <button type="submit">Add Game</button>
      </form>

      <h3>Schedule</h3>
      <div class="toolbar">
        <label for="teamFilter">Filter by Team:</label>
        <select id="teamFilter">
          <option value="all">All teams</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Team</th>
            <th>Opponent</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="scheduleTableBody"></tbody>
      </table>
    </div>

    <!-- SEND SCORES -->
    <div class="card">
      <h2>3. Enter Scores & Send Emails</h2>

      <div class="toolbar">
        <button type="button" id="resetGamesBtn" class="secondary">
          Reset Games (by Filter)
        </button>
        <button type="button" id="exportCsvBtn" class="blue">
          Export to CSV (Google Sheets)
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Team</th>
            <th>Opponent</th>
            <th>Location</th>
            <th>Your Score</th>
            <th>Opponent Score</th>
            <th>Send</th>
            <th>Sent?</th>
          </tr>
        </thead>
        <tbody id="scoreTableBody"></tbody>
      </table>

      <div id="sendMessage" class="message"></div>
    </div>
  </div>

  <!-- MAIN FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* FIREBASE CONFIG */
    const firebaseConfig = {
      apiKey: "AIzaSyDH1ERiRuZ8ELMjxQo96ChTZ25cjJI1HpY",
      authDomain: "score-submission-4d200.firebaseapp.com",
      projectId: "score-submission-4d200",
      storageBucket: "score-submission-4d200.firebasestorage.app",
      messagingSenderId: "421478998862",
      appId: "1:421478998862:web:b1964a65f3cc76998ff41f",
      measurementId: "G-GN4LLM30Q7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let state = { teamName: "", season: "", emails: [], games: [] };

    /* FIRESTORE HELPERS */
    function coachDoc() {
      if (!currentUser) throw new Error("No user");
      return doc(db, "coaches", currentUser.uid);
    }

    async function loadData() {
      const s = await getDoc(coachDoc());
      if (s.exists()) {
        const data = s.data();
        state.teamName = data.teamName;
        state.season = data.season;
        state.emails = data.emails;
      }
      const g = await getDocs(collection(coachDoc(), "games"));
      state.games = g.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function saveSettingsToFirestore() {
      await setDoc(coachDoc(), {
        teamName: state.teamName,
        season: state.season,
        emails: state.emails
      }, { merge: true });
    }

    async function addGameToFirestore(game) {
      const ref = await addDoc(collection(coachDoc(), "games"), game);
      return ref.id;
    }

    async function updateGameFirestore(game) {
      await updateDoc(doc(coachDoc(), "games", game.id), game);
    }

    async function deleteGameFromFirestore(gameId) {
      await deleteDoc(doc(coachDoc(), "games", gameId));
    }

    /* RENDER */
    function renderSettings() {
      document.getElementById("teamName").value = state.teamName || "";
      document.getElementById("season").value = state.season || "";
      document.getElementById("emails").value = (state.emails || []).join(", ");
    }

    function renderTeamFilter() {
      const select = document.getElementById("teamFilter");
      if (!select) return;

      const currentValue = select.value || "all";
      const levels = Array.from(
        new Set(
          state.games
            .map(g => g.teamLevel)
            .filter(Boolean)
        )
      );

      let optionsHtml = '<option value="all">All teams</option>';
      for (const level of levels) {
        const selectedAttr = level === currentValue ? "selected" : "";
        optionsHtml += `<option value="${level}" ${selectedAttr}>${level}</option>`;
      }
      select.innerHTML = optionsHtml;
    }

    function getFilteredGames() {
      const select = document.getElementById("teamFilter");
      const filterVal = select ? select.value : "all";

      const sorted = [...state.games].sort((a, b) =>
        (a.date || "").localeCompare(b.date || "")
      );

      if (filterVal === "all") return sorted;
      return sorted.filter(g => g.teamLevel === filterVal);
    }

    function renderTables() {
      renderTeamFilter();

      const sched = document.getElementById("scheduleTableBody");
      const score = document.getElementById("scoreTableBody");

      sched.innerHTML = "";
      score.innerHTML = "";

      const games = getFilteredGames();

      if (games.length === 0) {
        sched.innerHTML = '<tr><td colspan="5">No games added.</td></tr>';
        score.innerHTML = '<tr><td colspan="8">No games added.</td></tr>';
        return;
      }

      for (const g of games) {
        sched.innerHTML += `
          <tr>
            <td>${g.date || ""}</td>
            <td>${g.teamLevel || ""}</td>
            <td>${g.opponent || ""}</td>
            <td>${g.location || ""}</td>
            <td>${g.sent ? "Score emailed" : "Pending"}</td>
          </tr>`;

        score.innerHTML += `
          <tr>
            <td>${g.date || ""}</td>
            <td>${g.teamLevel || ""}</td>
            <td>${g.opponent || ""}</td>
            <td>${g.location || ""}</td>
            <td><input data-id="${g.id}" data-role="home" class="inline-input" type="number" value="${g.homeScore ?? ""}"></td>
            <td><input data-id="${g.id}" data-role="away" class="inline-input" type="number" value="${g.awayScore ?? ""}"></td>
            <td><button class="sendBtn" data-id="${g.id}">Send Score Email</button></td>
            <td>${g.sent ? "Sent" : "Not sent"}</td>
          </tr>`;
      }

      document.querySelectorAll(".sendBtn").forEach(btn =>
        btn.addEventListener("click", onSendScore)
      );
    }

    /* SEND EMAIL */
    function sendScoreEmail(game) {
      const teamLabel = game.teamLevel
        ? `${state.teamName} ${game.teamLevel}`
        : state.teamName;

      return emailjs.send(
        "service_zc1pbfj",
        "template_3fqvy3s",
        {
          team_name: teamLabel,
          season: game.season || state.season,
          game_date: game.date,
          opponent: game.opponent,
          location: game.location,
          home_score: game.homeScore,
          away_score: game.awayScore,
          email_list: state.emails.join(", "),
          subject_line: `${teamLabel} vs ${game.opponent} (${game.date}) Final Score`
        }
      );
    }

    /* FORM HANDLERS */
    async function onSettingsSubmit(e) {
      e.preventDefault();
      const msg = document.getElementById("settingsMessage");
      msg.textContent = "";

      if (!currentUser) {
        msg.textContent = "Please sign in first.";
        msg.className = "message error";
        return;
      }

      state.teamName = document.getElementById("teamName").value.trim();
      state.season = document.getElementById("season").value.trim();
      state.emails = document.getElementById("emails")
        .value.split(",")
        .map(s => s.trim())
        .filter(Boolean);

      try {
        await saveSettingsToFirestore();
        msg.textContent = "Settings saved!";
        msg.className = "message success";
      } catch (err) {
        console.error(err);
        msg.textContent = "Error saving settings.";
        msg.className = "message error";
      }
    }

    async function onAddGame(e) {
      e.preventDefault();
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";

      if (!currentUser) {
        sendMsg.textContent = "Please sign in first.";
        sendMsg.className = "message error";
        return;
      }

      const game = {
        date: document.getElementById("gameDate").value,
        teamLevel: document.getElementById("teamLevel").value.trim(),
        opponent: document.getElementById("opponent").value.trim(),
        location: document.getElementById("location").value.trim(),
        season: state.season || "",
        homeScore: null,
        awayScore: null,
        sent: false
      };

      if (!game.date || !game.teamLevel || !game.opponent || !game.location) {
        sendMsg.textContent = "Fill out all game fields.";
        sendMsg.className = "message error";
        return;
      }

      try {
        const id = await addGameToFirestore(game);
        state.games.push({ id, ...game });
        renderTables();
        document.getElementById("gameForm").reset();
      } catch (err) {
        console.error(err);
        sendMsg.textContent = "Error adding game.";
        sendMsg.className = "message error";
      }
    }

    async function onSendScore(e) {
      const id = e.target.getAttribute("data-id");
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";

      if (!currentUser) {
        sendMsg.textContent = "Please sign in.";
        sendMsg.className = "message error";
        return;
      }

      const game = state.games.find(g => g.id === id);
      if (!game) return;

      const home = document.querySelector(`input[data-id="${id}"][data-role="home"]`).value;
      const away = document.querySelector(`input[data-id="${id}"][data-role="away"]`).value;

      if (home === "" || away === "") {
        sendMsg.textContent = "Enter both scores before sending.";
        sendMsg.className = "message error";
        return;
      }

      game.homeScore = Number(home);
      game.awayScore = Number(away);

      console.log("Scores being sent:", game.homeScore, game.awayScore);

      try {
        await sendScoreEmail(game);
        game.sent = true;
        await updateGameFirestore(game);
        renderTables();
        sendMsg.textContent = "Score email sent!";
        sendMsg.className = "message success";
      } catch (err) {
        console.error("Email error:", err);
        sendMsg.textContent = "Email Error: " + (err.text || err.message);
        sendMsg.className = "message error";
      }
    }

    /* RESET GAMES – fixed: uses filter only, no season check */
    async function onResetGames() {
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";
      sendMsg.className = "message";

      if (!currentUser) {
        sendMsg.textContent = "Please sign in first.";
        sendMsg.className = "message error";
        return;
      }

      const select = document.getElementById("teamFilter");
      const filterVal = select ? select.value : "all";

      const confirmText =
        filterVal === "all"
          ? "Delete ALL games for this account (all teams)?"
          : `Delete ALL games for team \"${filterVal}\"?`;

      if (!window.confirm(confirmText)) return;

      const toDelete = state.games.filter(g =>
        filterVal === "all" || g.teamLevel === filterVal
      );

      if (!toDelete.length) {
        sendMsg.textContent = "No games found to reset for that selection.";
        sendMsg.className = "message error";
        return;
      }

      try {
        const idsToDelete = new Set(toDelete.map(g => g.id));
        for (const g of toDelete) {
          await deleteGameFromFirestore(g.id);
        }
        state.games = state.games.filter(g => !idsToDelete.has(g.id));
        renderTables();
        sendMsg.textContent = "Games reset for selected filter.";
        sendMsg.className = "message success";
      } catch (err) {
        console.error(err);
        sendMsg.textContent = "Error resetting games.";
        sendMsg.className = "message error";
      }
    }

    /* EXPORT CSV */
    function onExportCsv() {
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";
      sendMsg.className = "message";

      const games = getFilteredGames();
      if (!games.length) {
        sendMsg.textContent = "No games to export.";
        sendMsg.className = "message error";
        return;
      }

      const rows = [
        ["Date","Team","Season","Opponent","Location","Your Score","Opponent Score","Sent"]
      ];

      for (const g of games) {
        rows.push([
          g.date || "",
          g.teamLevel || "",
          g.season || state.season || "",
          g.opponent || "",
          g.location || "",
          g.homeScore ?? "",
          g.awayScore ?? "",
          g.sent ? "Yes" : "No"
        ]);
      }

      const csv = rows
        .map(row =>
          row
            .map(value => {
              const s = String(value ?? "");
              if (s.includes('"') || s.includes(",") || s.includes("\n")) {
                return `"${s.replace(/"/g, '""')}"`;
              }
              return s;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "game_scores.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      sendMsg.textContent = "CSV exported. Open it in Google Sheets.";
      sendMsg.className = "message success";
    }

    /* AUTH */
    async function handleLogin() {
      const msg = document.getElementById("authMessage");
      msg.textContent = "";

      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        msg.textContent = "Login failed: " + err.message;
        msg.className = "message error";
      }
    }

    async function handleLogout() {
      const msg = document.getElementById("authMessage");
      msg.textContent = "";

      try {
        await signOut(auth);
      } catch (err) {
        msg.textContent = "Logout failed: " + err.message;
        msg.className = "message error";
      }
    }

    onAuthStateChanged(auth, async user => {
      const status = document.getElementById("authStatus");
      const msg = document.getElementById("authMessage");
      msg.textContent = "";
      msg.className = "message";

      if (user) {
        currentUser = user;
        status.textContent = `Signed in as ${user.email}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";

        try {
          await loadData();
          renderSettings();
          renderTables();
        } catch (err) {
          console.error(err);
          msg.textContent = "Error loading your data.";
          msg.className = "message error";
        }

      } else {
        currentUser = null;
        status.textContent = "Not signed in";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("logoutBtn").style.display = "none";

        state = { teamName: "", season: "", emails: [], games: [] };
        renderSettings();
        renderTables();
      }
    });

    /* EVENTS */
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("logoutBtn").addEventListener("click", handleLogout);
    document.getElementById("settingsForm").addEventListener("submit", onSettingsSubmit);
    document.getElementById("gameForm").addEventListener("submit", onAddGame);
    document.getElementById("teamFilter").addEventListener("change", renderTables);
    document.getElementById("resetGamesBtn").addEventListener("click", onResetGames);
    document.getElementById("exportCsvBtn").addEventListener("click", onExportCsv);
  </script>
</body>
</html>


