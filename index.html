<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coach Game Score Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Basic styling -->
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
      color: #222;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.45rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-top: 0.25rem;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    button {
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #e53935;
      color: #fff;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.4rem;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .status-sent {
      color: #2e7d32;
      font-weight: 600;
    }

    .status-pending {
      color: #f57c00;
      font-weight: 600;
    }

    .small {
      font-size: 0.8rem;
      color: #666;
    }

    .inline-input {
      width: 80px;
    }

    .message {
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .message.success {
      color: #2e7d32;
    }

    .message.error {
      color: #c62828;
    }

    .auth-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .auth-row .buttons {
      display: flex;
      gap: 0.5rem;
    }

    @media (max-width: 700px) {
      table {
        font-size: 0.8rem;
      }
      .inline-input {
        width: 60px;
      }
    }
  </style>

  <!-- EmailJS -->
  <script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
  <script>
    emailjs.init("js0OsdaHtUNCJw2vP");
  </script>
</head>
<body>
  <div class="container">
    <h1>Coach Game Score Sender</h1>

    <!-- AUTH -->
    <div class="card">
      <div class="auth-row">
        <div>
          <strong>Account</strong>
          <div id="authStatus" class="small">Not signed in</div>
        </div>
        <div class="buttons">
          <button id="loginBtn" type="button">Sign in with Google</button>
          <button id="logoutBtn" type="button" style="display:none; background:#555;">
            Log out
          </button>
        </div>
      </div>
      <div id="authMessage" class="message"></div>
    </div>

    <!-- SETTINGS -->
    <div class="card">
      <h2>1. Season Setup</h2>
      <form id="settingsForm">
        <label>Team Name</label>
        <input id="teamName" type="text" required />

        <label>Season</label>
        <input id="season" type="text" required />

        <label>Email List (comma separated)</label>
        <textarea id="emails" required></textarea>

        <button type="submit">Save Settings</button>
        <div id="settingsMessage" class="message"></div>
      </form>
    </div>

    <!-- ADD GAME -->
    <div class="card">
      <h2>2. Add Games to Schedule</h2>

      <form id="gameForm">
        <label>Date</label>
        <input id="gameDate" type="date" required />

        <label>Opponent</label>
        <input id="opponent" type="text" required />

        <label>Location</label>
        <input id="location" type="text" required />

        <button type="submit">Add Game</button>
      </form>

      <h3>Schedule</h3>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Opponent</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="scheduleTableBody"></tbody>
      </table>
    </div>

    <!-- SEND SCORES -->
    <div class="card">
      <h2>3. Enter Scores & Send Emails</h2>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Opponent</th>
            <th>Location</th>
            <th>Your Score</th>
            <th>Opponent Score</th>
            <th>Send</th>
            <th>Sent?</th>
          </tr>
        </thead>
        <tbody id="scoreTableBody"></tbody>
      </table>

      <div id="sendMessage" class="message"></div>
    </div>
  </div>

  <!-- MAIN SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      addDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* FIREBASE CONFIG */
    const firebaseConfig = {
      apiKey: "AIzaSyDH1ERiRuZ8ELMjxQo96ChTZ25cjJI1HpY",
      authDomain: "score-submission-4d200.firebaseapp.com",
      projectId: "score-submission-4d200",
      storageBucket: "score-submission-4d200.firebasestorage.app",
      messagingSenderId: "421478998862",
      appId: "1:421478998862:web:b1964a65f3cc76998ff41f",
      measurementId: "G-GN4LLM30Q7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let state = { teamName: "", season: "", emails: [], games: [] };

    /* FIRESTORE HELPERS */
    function coachDoc() {
      if (!currentUser) throw new Error("No user for coachDoc");
      return doc(db, "coaches", currentUser.uid);
    }

    async function loadData() {
      const s = await getDoc(coachDoc());
      if (s.exists()) {
        const data = s.data();
        state.teamName = data.teamName || "";
        state.season = data.season || "";
        state.emails = data.emails || [];
      }
      const g = await getDocs(collection(coachDoc(), "games"));
      state.games = g.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function saveSettingsToFirestore() {
      await setDoc(
        coachDoc(),
        {
          teamName: state.teamName,
          season: state.season,
          emails: state.emails
        },
        { merge: true }
      );
    }

    async function addGameToFirestore(game) {
      const ref = await addDoc(collection(coachDoc(), "games"), game);
      return ref.id;
    }

    async function updateGameFirestore(game) {
      await updateDoc(doc(coachDoc(), "games", game.id), game);
    }

    /* RENDER */
    function renderSettings() {
      document.getElementById("teamName").value = state.teamName;
      document.getElementById("season").value = state.season;
      document.getElementById("emails").value = state.emails.join(", ");
    }

    function renderTables() {
      const sched = document.getElementById("scheduleTableBody");
      const score = document.getElementById("scoreTableBody");

      sched.innerHTML = "";
      score.innerHTML = "";

      if (state.games.length === 0) {
        sched.innerHTML = '<tr><td colspan="4">No games added.</td></tr>';
        score.innerHTML = '<tr><td colspan="7">No games added.</td></tr>';
        return;
      }

      const sorted = [...state.games].sort((a, b) => a.date.localeCompare(b.date));

      for (const g of sorted) {
        sched.innerHTML += `
          <tr>
            <td>${g.date}</td>
            <td>${g.opponent}</td>
            <td>${g.location}</td>
            <td>${g.sent ? "Score emailed" : "Pending"}</td>
          </tr>`;

        score.innerHTML += `
          <tr>
            <td>${g.date}</td>
            <td>${g.opponent}</td>
            <td>${g.location}</td>
            <td>
              <input data-id="${g.id}" data-role="home" class="inline-input"
                     type="number" value="${g.homeScore ?? ""}">
            </td>
            <td>
              <input data-id="${g.id}" data-role="away" class="inline-input"
                     type="number" value="${g.awayScore ?? ""}">
            </td>
            <td><button class="sendBtn" data-id="${g.id}">Send Score Email</button></td>
            <td>${g.sent ? "Sent" : "Not sent"}</td>
          </tr>`;
      }

      document.querySelectorAll(".sendBtn").forEach(btn =>
        btn.addEventListener("click", onSendScore)
      );
    }

    /* SEND EMAIL */
    function sendScoreEmail(game) {
      return emailjs.send(
        "service_zc1pbfj",
        "template_3fqvy3s",
        {
          team_name: state.teamName,
          season: state.season,
          game_date: game.date,
          opponent: game.opponent,
          location: game.location,
          home_score: game.homeScore,
          away_score: game.awayScore,
          email_list: state.emails.join(", "),
          subject_line: `${state.teamName} vs ${game.opponent} (${game.date}) Final Score`
        }
      );
    }

    /* HANDLERS */
    async function onSettingsSubmit(e) {
      e.preventDefault();
      const msg = document.getElementById("settingsMessage");
      msg.textContent = "";
      msg.className = "message";

      if (!currentUser) {
        msg.textContent = "Please sign in with Google first.";
        msg.classList.add("error");
        return;
      }

      state.teamName = document.getElementById("teamName").value.trim();
      state.season = document.getElementById("season").value.trim();
      state.emails = document
        .getElementById("emails")
        .value.split(",")
        .map(e => e.trim())
        .filter(e => e.length);

      try {
        await saveSettingsToFirestore();
        msg.textContent = "Settings saved!";
        msg.classList.add("success");
      } catch (err) {
        console.error(err);
        msg.textContent = "Error saving settings.";
        msg.classList.add("error");
      }
    }

    async function onAddGame(e) {
      e.preventDefault();
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";
      sendMsg.className = "message";

      if (!currentUser) {
        sendMsg.textContent = "Please sign in with Google first.";
        sendMsg.classList.add("error");
        return;
      }

      const game = {
        date: document.getElementById("gameDate").value,
        opponent: document.getElementById("opponent").value.trim(),
        location: document.getElementById("location").value.trim(),
        homeScore: null,
        awayScore: null,
        sent: false
      };

      if (!game.date || !game.opponent || !game.location) return;

      try {
        const id = await addGameToFirestore(game);
        state.games.push({ id, ...game });
        renderTables();
        document.getElementById("gameForm").reset();
      } catch (err) {
        console.error(err);
        sendMsg.textContent = "Error adding game.";
        sendMsg.classList.add("error");
      }
    }

    async function onSendScore(e) {
      const id = e.target.getAttribute("data-id");
      const sendMsg = document.getElementById("sendMessage");
      sendMsg.textContent = "";
      sendMsg.className = "message";

      if (!currentUser) {
        sendMsg.textContent = "Please sign in with Google first.";
        sendMsg.classList.add("error");
        return;
      }

      const game = state.games.find(g => g.id === id);
      if (!game) return;

      const home = document.querySelector(
        `input[data-id="${id}"][data-role="home"]`
      ).value;
      const away = document.querySelector(
        `input[data-id="${id}"][data-role="away"]`
      ).value;

      if (home === "" || away === "") {
        sendMsg.textContent = "Enter both scores before sending.";
        sendMsg.classList.add("error");
        return;
      }

      game.homeScore = Number(home);
      game.awayScore = Number(away);

      try {
        await sendScoreEmail(game);
        game.sent = true;
        await updateGameFirestore(game);
        renderTables();
        sendMsg.textContent = "Score email sent!";
        sendMsg.classList.add("success");
      } catch (err) {
        console.error("Email error:", err);
        sendMsg.textContent =
          "Email Error: " + (err?.text || err?.message || "Unknown error");
        sendMsg.classList.add("error");
      }
    }

    /* AUTH HANDLERS */
    async function handleLogin() {
      const authMsg = document.getElementById("authMessage");
      authMsg.textContent = "";
      authMsg.className = "message";

      try {
        await signInWithPopup(auth, provider);
        // onAuthStateChanged will fire after this
      } catch (err) {
        console.error("Login error:", err);
        authMsg.textContent =
          "Login failed: " + (err?.message || err?.code || "Unknown error");
        authMsg.classList.add("error");
      }
    }

    async function handleLogout() {
      const authMsg = document.getElementById("authMessage");
      authMsg.textContent = "";
      authMsg.className = "message";

      try {
        await signOut(auth);
      } catch (err) {
        console.error("Logout error:", err);
        authMsg.textContent =
          "Logout failed: " + (err?.message || err?.code || "Unknown error");
        authMsg.classList.add("error");
      }
    }

    /* AUTH STATE LISTENER */
    onAuthStateChanged(auth, async user => {
      const authStatus = document.getElementById("authStatus");
      const authMsg = document.getElementById("authMessage");

      authMsg.textContent = "";
      authMsg.className = "message";

      if (user) {
        currentUser = user;
        authStatus.textContent = `Signed in as ${user.email}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";

        try {
          await loadData();
          renderSettings();
          renderTables();
        } catch (err) {
          console.error("Load data error:", err);
          authMsg.textContent = "Error loading your data.";
          authMsg.classList.add("error");
        }
      } else {
        currentUser = null;
        authStatus.textContent = "Not signed in";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("logoutBtn").style.display = "none";
        state = { teamName: "", season: "", emails: [], games: [] };
        renderSettings();
        renderTables();
      }
    });

    /* WIRE UP EVENTS */
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("logoutBtn").addEventListener("click", handleLogout);
    document
      .getElementById("settingsForm")
      .addEventListener("submit", onSettingsSubmit);
    document
      .getElementById("gameForm")
      .addEventListener("submit", onAddGame);
  </script>
</body>
</html>








